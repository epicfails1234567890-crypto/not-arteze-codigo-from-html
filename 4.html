<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>JS Custom - Eval en Leer</title>
    <style>
        body { font-family: 'Consolas', monospace; background: #1e1e1e; color: #dcdcdc; padding: 20px; }
        #editor { width: 100%; height: 250px; background: #252526; color: #9cdcfe; border: 1px solid #333; padding: 15px; font-size: 16px; border-radius: 4px; outline: none; }
        #consola { background: #000; border: 1px solid #333; padding: 15px; margin-top: 15px; min-height: 120px; border-radius: 4px; white-space: pre-wrap; }
        button { background: #0e639c; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 2px; margin-bottom: 10px; }
        .input-line { display: flex; color: #ce9178; }
        #user-input { background: transparent; border: none; color: #ce9178; outline: none; font-family: monospace; font-size: 16px; width: 100%; }
    </style>
</head>
<body>

    <textarea id="editor" spellcheck="false">
console.log("Escribe una operacion (ej: 10 * 5 + 2):");
let dato = await Leer();

console.log("El resultado evaluado es: " + dato);

if dato > 50 {
    console.log("Es un numero grande");
}
    </textarea>
    
    <br>
    <button onclick="ejecutar()">Ejecutar</button>

    <div id="consola">
        <div id="salida"></div>
        <div class="input-line" id="prompt-area" style="display:none">
            <span>> </span><input type="text" id="user-input" autocomplete="off">
        </div>
    </div>

<script>
    const salida = document.getElementById('salida');
    const inputArea = document.getElementById('prompt-area');
    const inputField = document.getElementById('user-input');

    // Función Leer con EVALUACIÓN de expresiones
    function Leer() {
        return new Promise(resolve => {
            inputArea.style.display = "flex";
            inputField.focus();
            inputField.onkeydown = (e) => {
                if (e.key === "Enter") {
                    let rawVal = inputField.value;
                    inputField.value = "";
                    inputArea.style.display = "none";
                    salida.innerHTML += `<span style="color:gray">${rawVal}</span>\n`;

                    try {
                        // Intentamos evaluar lo que el usuario escribió
                        // Si escribe "5+5", resolverá 10.
                        // Si escribe "hola", fallará y lo devolverá como string.
                        let evaluado = eval(rawVal);
                        resolve(evaluado);
                    } catch (err) {
                        // Si no es una expresión válida, lo tratamos como texto
                        resolve(rawVal);
                    }
                }
            };
        });
    }

    const customConsole = {
        log: (...args) => { salida.innerHTML += args.join(" ") + "\n"; }
    };

    async function ejecutar() {
        salida.innerHTML = "";
        let codigo = document.getElementById('editor').value;

        // Pre-procesador de bloques sin paréntesis
        codigo = codigo.replace(/if\s+(?![\(])(.+?)\s*\{/g, 'if ($1) {');
        codigo = codigo.replace(/while\s+(?![\(])(.+?)\s*\{/g, 'while ($1) {');
        codigo = codigo.replace(/for\s+(?![\(])(.+?)\s*\{/g, 'for ($1) {');

        try {
            const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
            // Inyectamos Leer y console al contexto de la función
            const programa = new AsyncFunction("Leer", "console", codigo);
            await programa(Leer, customConsole);
        } catch (e) {
            salida.innerHTML += `<span style="color:#f44747">Error: ${e.message}</span>\n`;
        }
    }
</script>
</body>
</html>