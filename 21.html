<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Javascript++</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1e1e1e; color: #d4d4d4; padding: 20px; line-height: 1.6; }
        h3 { color: #569cd6; border-bottom: 1px solid #333; padding-bottom: 10px; }
        #editor { width: 100%; height: 350px; background: #252526; color: #dcdcdc; border: 1px solid #3c3c3c; padding: 15px; font-size: 16px; border-radius: 6px; outline: none; font-family: 'Consolas', 'Courier New', monospace; box-sizing: border-box; }
        #consola { background: #000; border: 1px solid #333; padding: 15px; margin-top: 15px; min-height: 150px; border-radius: 4px; white-space: pre-wrap; font-family: 'Consolas', monospace; color: #4ec9b0; border-left: 5px solid #2d8a4e; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .toolbar { margin-bottom: 15px; display: flex; gap: 10px; }
        button { background: #2d8a4e; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 13px; text-transform: uppercase; }
        button:hover { background: #3aa65e; }
        .btn-blue { background: #007acc; }
        .input-line { display: flex; color: #ce9178; margin-top: 5px; }
        #user-input { background: transparent; border: none; color: #ce9178; outline: none; font-family: 'Consolas', monospace; font-size: 16px; width: 100%; }
        .error { color: #f44747; font-weight: bold; }
    </style>
</head>
<body>

    <h3>Javascript++ (Write Edition)</h3>
    
    <div class="toolbar">
        <button onclick="ejecutar()">â–¶ Ejecutar CÃ³digo</button>
        <button class="btn-blue" onclick="descargarCodigo()">ðŸ’¾ Guardar .txt</button>
        <button class="btn-blue" onclick="document.getElementById('file-input').click()">ðŸ“‚ Abrir .txt</button>
        <input type="file" id="file-input" style="display:none" accept=".txt" onchange="cargarCodigo(event)">
    </div>

    <textarea id="editor" spellcheck="false">
esprimo = (n) => {
    if n < 2 { return 0 }
    check = 1
    for let i = 2; i < n; i++ {
        if n % i == 0 {
            check = 0
        }
    }
    return check
}

write "Calculando nÃºmeros primos..."

for let j = 1; j < 50; j++ {
    // Usamos await porque el intÃ©rprete es async
    let resultado = await esprimo(j)
    if resultado == 1 {
        write "Primo encontrado: " + j
    }
}
    </textarea>
    
    <div id="consola">
        <div id="salida"></div>
        <div class="input-line" id="prompt-area" style="display:none">
            <span>> </span><input type="text" id="user-input" autocomplete="off">
        </div>
    </div>

<script>
    const salida = document.getElementById('salida');
    const inputArea = document.getElementById('prompt-area');
    const inputField = document.getElementById('user-input');
    const editor = document.getElementById('editor');

    // --- Soporte para tecla Tab ---
    editor.addEventListener("keydown", function(e) {
        if (e.key === "Tab") {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            const tab = "    "; 
            this.value = this.value.substring(0, start) + tab + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + tab.length;
        }
    });

    function descargarCodigo() {
        const nombre = prompt('Nombre del archivo:', 'codigo.txt');
        if (!nombre) return;
        const blob = new Blob([editor.value], { type: 'text/plain' });
        const enlace = document.createElement('a');
        enlace.href = URL.createObjectURL(blob);
        enlace.download = nombre.endsWith('.txt') ? nombre : nombre + '.txt';
        enlace.click();
    }

    function cargarCodigo(evento) {
        const archivo = evento.target.files[0];
        if (!archivo) return;
        const lector = new FileReader();
        lector.onload = (e) => { editor.value = e.target.result; };
        lector.readAsText(archivo);
    }

    function Leer() {
        return new Promise(resolve => {
            inputArea.style.display = "flex";
            inputField.focus();
            inputField.onkeydown = (e) => {
                if (e.key === "Enter") {
                    let val = inputField.value;
                    inputField.value = "";
                    inputArea.style.display = "none";
                    salida.innerHTML += `<span style="color: #858585">// Entrada: ${val}</span>\n`;
                    try { resolve(eval(val)); } catch { resolve(val); }
                }
            };
        });
    }

    // DefiniciÃ³n de la funciÃ³n write
    function write(...args) {
        salida.innerHTML += args.join(" ") + "\n";
    }

    async function ejecutar() {
        salida.innerHTML = "";
        let codigo = editor.value;
        
        // 1. Transformar estructuras de control (if, while, for sin parÃ©ntesis)
        codigo = codigo.replace(/\bif\s+(?![\(])(.+?)\s*\{/g, 'if ($1) {');
        codigo = codigo.replace(/\belse\s*\{/g, 'else {');
        codigo = codigo.replace(/\bwhile\s+(?![\(])(.+?)\s*\{/g, 'while ($1) {');
        codigo = codigo.replace(/\bfor\s+(?![\(])(.+?)\s*\{/g, 'for ($1) {');

        // 2. TraducciÃ³n de 'write' (de estilo comando a estilo funciÃ³n)
        codigo = codigo.split('\n').map(linea => {
            let t = linea.trim();
            // Si la lÃ­nea empieza con write y un espacio, y no tiene ya parÃ©ntesis
            if (t.startsWith("write ") && !t.includes("write(")) {
                return linea.replace("write ", "write(") + ");";
            }
            return linea;
        }).join('\n');

        try {
            // Crear la funciÃ³n asÃ­ncrona inyectando Leer y write
            const AsyncFunc = Object.getPrototypeOf(async function(){}).constructor;
            const programa = new AsyncFunc("Leer", "write", "console", codigo);
            
            // Ejecutar pasando las referencias reales de las funciones
            await programa(Leer, write, {log: write});
        } catch (e) {
            salida.innerHTML += `<span class="error">Error: ${e.message}</span>\n`;
        }
    }
</script>

</body>
</html>
